- name: Render Terraform Templates for Different Environments
  hosts: localhost
  gather_facts: no
  vars:
    env: "{{ lookup('env', 'ENV') | default('dev', true) }}" # Default to 'dev' if ENV is not set
  tasks:
  - name: Load environment-specific variables
    include_vars:
      file: "vars/{{ env }}.yaml"

  - name: Find all Terraform template files
    find:
      paths: "templates/"
      patterns: "*.tf.j2"
    register: template_files

  - name: Render Terraform templates
    template:
      src: "{{ item.path }}"
      dest: "rendered/{{ item.path | basename | regex_replace('.j2$', '') | replace('.tf', '-'+env+'.tf') }}"
    loop: "{{ template_files.files }}"

  - name: Debug rendered files
    command: cat "rendered/*-{{ env }}.tf"
    register: tf_output
    changed_when: false

  - debug:
      msg: "{{ tf_output.stdout }}"
