- name: Render Terraform Templates for Different Environments
  hosts: all
  connection: local
  gather_facts: no

  tasks:
  - name: Load environment-specific variables
    include_vars:
      file: "vars/{{ env }}.yaml"

  - name: Find all Terraform template files
    find:
      paths: "{{ playbook_dir }}"
      patterns: "*.tf.j2"
    register: template_files

  - name: Render Terraform templates
    template:
      src: "{{ item.path }}"
      dest: "{{ item.path | basename | regex_replace('.j2$', '') | regex_replace(r'(\\.tf)$', '-' ~ env ~ '\\1') }}"
    loop: "{{ template_files.files }}"

  - name: Debug rendered files
    command: cat "*-{{ env }}.tf"
    register: tf_output
    changed_when: false

  - debug:
      msg: "{{ tf_output.stdout }}"
